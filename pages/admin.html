<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - M√©caPro</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/auth.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
</head>

<body class="admin-page">
    <div class="admin-container">
        <div class="admin-header">
            <h1>üîß Administration M√©caPro</h1>
            <div class="admin-actions">
                <a href="../index.html" class="btn-secondary">‚Üê Retour</a>
                <button onclick="logoutUser()" class="btn-secondary">D√©connexion</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="admin-stats">
            <div class="stat-card">
                <span class="icon">üë•</span>
                <h3>Utilisateurs</h3>
                <div class="value" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
                <span class="icon">üìù</span>
                <h3>Quiz compl√©t√©s</h3>
                <div class="value" id="totalQuizzes">0</div>
            </div>
            <div class="stat-card">
                <span class="icon">üìö</span>
                <h3>Le√ßons termin√©es</h3>
                <div class="value" id="totalLessons">0</div>
            </div>
            <div class="stat-card">
                <span class="icon">üîç</span>
                <h3>Diagnostics</h3>
                <div class="value" id="totalDiagnostics">0</div>
            </div>
        </div>

        <!-- Create User Form -->
        <div class="create-user-form" id="createUserSection">
            <h3>‚ûï Cr√©er un nouvel utilisateur</h3>
            <form id="createUserForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom complet</label>
                        <input type="text" id="newDisplayName" required placeholder="Jean Dupont">
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="newEmail" required placeholder="jean@exemple.com">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Mot de passe</label>
                        <input type="password" id="newPassword" required placeholder="Minimum 6 caract√®res"
                            minlength="6">
                    </div>
                    <div class="form-group">
                        <label>R√¥le</label>
                        <select id="newRole">
                            <option value="user">Utilisateur</option>
                            <option value="admin">Administrateur</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn-primary">Cr√©er l'utilisateur</button>
            </form>
        </div>

        <!-- Users List -->
        <div class="users-section">
            <h2>
                üë• Liste des utilisateurs
                <button onclick="refreshUsers()" class="btn-secondary" style="font-size: 12px;">üîÑ Actualiser</button>
            </h2>
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Utilisateur</th>
                        <th>E-mail</th>
                        <th>R√¥le</th>
                        <th>Quiz</th>
                        <th>Progression</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">Chargement...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="userDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="modalUserName">D√©tails utilisateur</h3>
            <div id="modalUserContent" class="user-details"></div>
            <div class="modal-actions">
                <button onclick="closeUserModal()" class="btn-secondary">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/user-data.js"></script>

    <script>
        // Check admin access
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            const isAdmin = await isUserAdmin(user.uid);
            if (!isAdmin) {
                alert('Acc√®s r√©serv√© aux administrateurs');
                window.location.href = '../index.html';
                return;
            }

            loadAdminDashboard();
        });

        // Load dashboard data
        async function loadAdminDashboard() {
            const users = await getAllUsers();

            let totalQuizzes = 0;
            let totalLessons = 0;
            let totalDiagnostics = 0;

            users.forEach(user => {
                totalQuizzes += Object.keys(user.quizScores || {}).length;
                Object.values(user.progress || {}).forEach(lessons => {
                    totalLessons += lessons.length;
                });
                totalDiagnostics += (user.diagnosticHistory || []).length;
            });

            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalQuizzes').textContent = totalQuizzes;
            document.getElementById('totalLessons').textContent = totalLessons;
            document.getElementById('totalDiagnostics').textContent = totalDiagnostics;

            renderUsersTable(users);
        }

        // Render users table
        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">Aucun utilisateur</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const quizCount = Object.keys(user.quizScores || {}).length;
                let lessonCount = 0;
                Object.values(user.progress || {}).forEach(lessons => {
                    lessonCount += lessons.length;
                });

                return `
                    <tr>
                        <td>${user.displayName || 'Sans nom'}</td>
                        <td>${user.email}</td>
                        <td><span class="role-badge ${user.role}">${user.role === 'admin' ? 'Admin' : 'Utilisateur'}</span></td>
                        <td>${quizCount}</td>
                        <td>${lessonCount} le√ßons</td>
                        <td>
                            <button class="action-btn view" onclick="viewUserDetails('${user.uid}')">üëÅÔ∏è Voir</button>
                            ${user.role !== 'admin' ? `<button class="action-btn delete" onclick="confirmDeleteUser('${user.uid}', '${user.email}')">üóëÔ∏è</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Refresh users
        function refreshUsers() {
            loadAdminDashboard();
        }

        // Create user form
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const displayName = document.getElementById('newDisplayName').value;
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;

            const result = await createUser(email, password, displayName, role);

            if (result.success) {
                alert('Utilisateur cr√©√© avec succ√®s !');
                document.getElementById('createUserForm').reset();
                refreshUsers();
            } else {
                alert('Erreur: ' + result.error);
            }
        });

        // View user details
        async function viewUserDetails(uid) {
            const users = await getAllUsers();
            const user = users.find(u => u.uid === uid);

            if (!user) return;

            document.getElementById('modalUserName').textContent = user.displayName || user.email;

            const quizCount = Object.keys(user.quizScores || {}).length;
            let lessonCount = 0;
            Object.values(user.progress || {}).forEach(lessons => {
                lessonCount += lessons.length;
            });
            const favCount = (user.favorites || []).length;
            const diagCount = (user.diagnosticHistory || []).length;

            // Calculate average score
            let totalScore = 0;
            let totalPossible = 0;
            Object.values(user.quizScores || {}).forEach(score => {
                totalScore += score.score;
                totalPossible += score.total;
            });
            const avgScore = totalPossible > 0 ? Math.round((totalScore / totalPossible) * 100) : 0;

            document.getElementById('modalUserContent').innerHTML = `
                <p><strong>E-mail:</strong> ${user.email}</p>
                <p><strong>R√¥le:</strong> ${user.role === 'admin' ? 'Administrateur' : 'Utilisateur'}</p>
                <p><strong>Inscrit le:</strong> ${user.createdAt ? new Date(user.createdAt).toLocaleDateString('fr-FR') : 'Inconnu'}</p>
                
                <h4>üìä Statistiques</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="value">${quizCount}</div>
                        <div class="label">Quiz</div>
                    </div>
                    <div class="stat-item">
                        <div class="value">${avgScore}%</div>
                        <div class="label">Score moyen</div>
                    </div>
                    <div class="stat-item">
                        <div class="value">${lessonCount}</div>
                        <div class="label">Le√ßons</div>
                    </div>
                    <div class="stat-item">
                        <div class="value">${diagCount}</div>
                        <div class="label">Diagnostics</div>
                    </div>
                </div>
            `;

            document.getElementById('userDetailsModal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('userDetailsModal').style.display = 'none';
        }

        // Delete user
        async function confirmDeleteUser(uid, email) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur ${email} ?`)) {
                const result = await deleteUser(uid);
                if (result.success) {
                    alert('Utilisateur supprim√©');
                    refreshUsers();
                } else {
                    alert('Erreur: ' + result.error);
                }
            }
        }
    </script>
</body>

</html>