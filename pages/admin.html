<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervision - M√©caPro</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/auth.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
</head>

<body class="admin-page">
    <div class="admin-container">
        <div class="admin-header">
            <h1>üõ°Ô∏è Panneau Superviseur - M√©caPro</h1>
            <div class="admin-actions">
                <a href="../index.html" class="btn-secondary">‚Üê Accueil</a>
                <button onclick="logoutUser()" class="btn-secondary">D√©connexion</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="admin-stats">
            <div class="stat-card">
                <span class="icon">üë•</span>
                <h3>Utilisateurs</h3>
                <div class="value" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
                <span class="icon">üìù</span>
                <h3>Quiz compl√©t√©s</h3>
                <div class="value" id="totalQuizzes">0</div>
            </div>
            <div class="stat-card">
                <span class="icon">üìö</span>
                <h3>Le√ßons termin√©es</h3>
                <div class="value" id="totalLessons">0</div>
            </div>
            <div class="stat-card">
                <span class="icon">üîç</span>
                <h3>Diagnostics</h3>
                <div class="value" id="totalDiagnostics">0</div>
            </div>
        </div>

        <!-- Create User Form -->
        <div class="create-user-form" id="createUserSection">
            <h3>‚ûï Cr√©er un nouvel utilisateur</h3>
            <form id="createUserForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom complet</label>
                        <input type="text" id="newDisplayName" required placeholder="Jean Dupont">
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="newEmail" required placeholder="jean@exemple.com">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Mot de passe</label>
                        <input type="password" id="newPassword" required placeholder="Minimum 6 caract√®res"
                            minlength="6">
                    </div>
                    <div class="form-group">
                        <label>R√¥le</label>
                        <select id="newRole">
                            <option value="user">Utilisateur</option>
                            <option value="superviseur">Superviseur</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn-primary">Cr√©er l'utilisateur</button>
            </form>
        </div>

        <!-- Users List -->
        <div class="users-section">
            <h2>
                üë• Liste des utilisateurs
                <button onclick="refreshUsers()" class="btn-secondary" style="font-size: 12px;">üîÑ Actualiser</button>
            </h2>
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Utilisateur</th>
                        <th>E-mail</th>
                        <th>R√¥le</th>
                        <th>Quiz</th>
                        <th>Progression</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">Chargement...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="userDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="modalUserName">D√©tails utilisateur</h3>
            <div id="modalUserContent" class="user-details"></div>
            <div class="modal-actions">
                <button onclick="closeUserModal()" class="btn-secondary">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h3>‚úèÔ∏è Modifier l'utilisateur</h3>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>Nom complet</label>
                    <input type="text" id="editDisplayName" required>
                </div>
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="editEmail" readonly style="opacity: 0.6; cursor: not-allowed;">
                    <small style="color: rgba(255,255,255,0.5);">L'email ne peut pas √™tre modifi√©</small>
                </div>
                <div class="form-group">
                    <label>R√¥le</label>
                    <select id="editRole">
                        <option value="user">Utilisateur</option>
                        <option value="superviseur">Superviseur</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeEditModal()" class="btn-secondary">Annuler</button>
                    <button type="submit" class="btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Devices Modal -->
    <div id="devicesModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="devicesModalTitle">üì± Appareils connect√©s</h3>
            <div id="devicesList" class="devices-list">
                <!-- Les sessions seront charg√©es ici -->
            </div>
            <div class="modal-actions">
                <button onclick="closeDevicesModal()" class="btn-secondary">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/user-data.js"></script>

    <script>
        // Check supervisor access
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            const isAdmin = await isUserAdmin(user.uid);
            if (!isAdmin) {
                alert('Acc√®s r√©serv√© aux superviseurs');
                window.location.href = '../index.html';
                return;
            }

            loadAdminDashboard();
        });

        // Load dashboard data
        async function loadAdminDashboard() {
            const users = await getAllUsers();

            let totalQuizzes = 0;
            let totalLessons = 0;
            let totalDiagnostics = 0;

            users.forEach(user => {
                totalQuizzes += Object.keys(user.quizScores || {}).length;
                Object.values(user.progress || {}).forEach(lessons => {
                    totalLessons += lessons.length;
                });
                totalDiagnostics += (user.diagnosticHistory || []).length;
            });

            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalQuizzes').textContent = totalQuizzes;
            document.getElementById('totalLessons').textContent = totalLessons;
            document.getElementById('totalDiagnostics').textContent = totalDiagnostics;

            renderUsersTable(users);
        }

        // Render users table
        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">Aucun utilisateur</td></tr>';
                return;
            }

            const currentUid = currentUser ? currentUser.uid : null;

            tbody.innerHTML = users.map(user => {
                const quizCount = Object.keys(user.quizScores || {}).length;
                let lessonCount = 0;
                Object.values(user.progress || {}).forEach(lessons => {
                    lessonCount += lessons.length;
                });

                const canModify = user.uid !== currentUid;
                const roleLabel = user.role === 'superviseur' ? 'Superviseur' : 'Utilisateur';
                const roleClass = user.role === 'superviseur' ? 'admin' : 'user';

                return `
                    <tr>
                        <td>${user.displayName || 'Sans nom'}</td>
                        <td>${user.email}</td>
                        <td><span class="role-badge ${roleClass}">${roleLabel}</span></td>
                        <td>${quizCount}</td>
                        <td>${lessonCount} le√ßons</td>
                        <td class="actions-cell">
                            <button class="action-btn view" onclick="viewUserDetails('${user.uid}')">üëÅÔ∏è Voir</button>
                            ${canModify ? `
                                <button class="action-btn edit" onclick="openEditModal('${user.uid}')">‚úèÔ∏è</button>
                                <button class="action-btn devices" onclick="viewUserDevices('${user.uid}', '${user.displayName || user.email}')">üì±</button>
                                <button class="action-btn reset" onclick="confirmResetProgress('${user.uid}', '${user.displayName || user.email}')">üîÑ</button>
                                <button class="action-btn delete" onclick="confirmDeleteUser('${user.uid}', '${user.email}', '${user.displayName || user.email}')">üóëÔ∏è</button>
                            ` : '<span class="self-badge">Vous</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // View user devices
        async function viewUserDevices(uid, userName) {
            document.getElementById('devicesModalTitle').textContent = `üì± Appareils de ${userName}`;
            const devicesList = document.getElementById('devicesList');
            devicesList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5);">Chargement des sessions...</p>';
            document.getElementById('devicesModal').style.display = 'flex';

            try {
                const snapshot = await database.ref(`users/${uid}/sessions`).once('value');

                if (!snapshot.exists()) {
                    devicesList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5);">Aucun appareil connect√© d√©tect√©.</p>';
                    return;
                }

                const sessions = [];
                snapshot.forEach(child => {
                    sessions.push({ id: child.key, ...child.val() });
                });

                // Sort by last active (most recent first)
                sessions.sort((a, b) => (b.lastActive || 0) - (a.lastActive || 0));

                devicesList.innerHTML = sessions.map(session => {
                    const lastActiveDate = session.lastActive ? new Date(session.lastActive).toLocaleString('fr-FR') : 'Inconnu';
                    const isCurrentDevice = session.deviceId === SessionManager.getDeviceId();

                    // Determine status based on last active (e.g., active within last 10 mins)
                    const timeDiff = Date.now() - (session.lastActive || 0);
                    const isActive = timeDiff < 10 * 60 * 1000; // 10 minutes
                    const statusClass = isActive ? 'status-active' : 'status-inactive';
                    const statusText = isActive ? 'En ligne' : 'Hors ligne';

                    return `
                        <div class="device-item ${isCurrentDevice ? 'current-device' : ''}">
                            <div class="device-info">
                                <div class="device-header">
                                    <span class="device-name">${session.os} - ${session.browser}</span>
                                    ${isCurrentDevice ? '<span class="badge-current">Actuel</span>' : ''}
                                </div>
                                <div class="device-details">
                                    <span>IP: ${session.ip || 'Inconnue'}</span> ‚Ä¢ 
                                    <span>Derni√®re activit√©: ${lastActiveDate}</span>
                                </div>
                                <div class="device-status">
                                    <span class="status-dot ${statusClass}"></span> ${statusText}
                                </div>
                            </div>
                            <div class="device-actions">
                                <button class="action-btn revoke" onclick="confirmRevokeSession('${uid}', '${session.id}')">D√©connecter</button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error("Erreur r√©cup√©ration sessions:", error);
                devicesList.innerHTML = '<p style="text-align: center; color: #ef4444;">Erreur lors du chargement des sessions.</p>';
            }
        }

        function closeDevicesModal() {
            document.getElementById('devicesModal').style.display = 'none';
        }

        async function confirmRevokeSession(uid, sessionId) {
            if (confirm("√ätes-vous s√ªr de vouloir d√©connecter cet appareil ?")) {
                try {
                    await SessionManager.revokeSession(uid, sessionId);
                    // Refresh the list logic is a bit complex since fetching requires async. 
                    // Let's just remove the element from DOM or reload the list.
                    // Ideally we call viewUserDevices again but we need userName.
                    // Simple hack: remove the element visually
                    const btn = event.target;
                    const deviceItem = btn.closest('.device-item');
                    deviceItem.style.opacity = '0.5';
                    deviceItem.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 10px;">D√©connect√©</p>';
                    setTimeout(() => deviceItem.remove(), 1000);
                } catch (error) {
                    alert("Erreur: " + error.message);
                }
            }
        }

        // Refresh users
        function refreshUsers() {
            loadAdminDashboard();
        }

        // Create user form
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const displayName = document.getElementById('newDisplayName').value;
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;

            const result = await createUser(email, password, displayName, role);

            if (result.success) {
                alert('‚úÖ Utilisateur cr√©√© avec succ√®s !');
                document.getElementById('createUserForm').reset();
                refreshUsers();
            } else {
                alert('‚ùå Erreur: ' + result.error);
            }
        });

        // View user details with full statistics
        async function viewUserDetails(uid) {
            const users = await getAllUsers();
            const user = users.find(u => u.uid === uid);

            if (!user) return;

            document.getElementById('modalUserName').textContent = user.displayName || user.email;

            const quizScores = user.quizScores || {};
            const quizCount = Object.keys(quizScores).length;
            let lessonCount = 0;
            const progressDetails = [];

            Object.entries(user.progress || {}).forEach(([module, lessons]) => {
                lessonCount += lessons.length;
                progressDetails.push(`<li><strong>${module}:</strong> ${lessons.length} le√ßon(s)</li>`);
            });

            const favCount = (user.favorites || []).length;
            const diagCount = (user.diagnosticHistory || []).length;

            // Calculate average score
            let totalScore = 0;
            let totalPossible = 0;
            const quizDetails = [];
            Object.entries(quizScores).forEach(([quizName, score]) => {
                totalScore += score.score;
                totalPossible += score.total;
                const percent = Math.round((score.score / score.total) * 100);
                quizDetails.push(`<li><strong>${quizName}:</strong> ${score.score}/${score.total} (${percent}%)</li>`);
            });
            const avgScore = totalPossible > 0 ? Math.round((totalScore / totalPossible) * 100) : 0;

            const roleLabel = user.role === 'superviseur' ? 'Superviseur' : 'Utilisateur';

            document.getElementById('modalUserContent').innerHTML = `
                <p><strong>E-mail:</strong> ${user.email}</p>
                <p><strong>R√¥le:</strong> ${roleLabel}</p>
                <p><strong>Inscrit le:</strong> ${user.createdAt ? new Date(user.createdAt).toLocaleDateString('fr-FR') : 'Inconnu'}</p>
                
                <h4>üìä Statistiques globales</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="value">${quizCount}</div>
                        <div class="label">Quiz</div>
                    </div>
                    <div class="stat-item">
                        <div class="value">${avgScore}%</div>
                        <div class="label">Score moyen</div>
                    </div>
                    <div class="stat-item">
                        <div class="value">${lessonCount}</div>
                        <div class="label">Le√ßons</div>
                    </div>
                    <div class="stat-item">
                        <div class="value">${diagCount}</div>
                        <div class="label">Diagnostics</div>
                    </div>
                </div>

                ${quizDetails.length > 0 ? `
                    <h4>üìù D√©tail des Quiz</h4>
                    <ul style="color: rgba(255,255,255,0.8); font-size: 14px;">${quizDetails.join('')}</ul>
                ` : ''}

                ${progressDetails.length > 0 ? `
                    <h4>üìö Progression par module</h4>
                    <ul style="color: rgba(255,255,255,0.8); font-size: 14px;">${progressDetails.join('')}</ul>
                ` : ''}

                <p style="margin-top: 16px;"><strong>‚ù§Ô∏è Favoris:</strong> ${favCount} √©l√©ment(s)</p>
            `;

            document.getElementById('userDetailsModal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('userDetailsModal').style.display = 'none';
        }

        // Edit user modal
        async function openEditModal(uid) {
            const users = await getAllUsers();
            const user = users.find(u => u.uid === uid);

            if (!user) return;

            document.getElementById('editUserId').value = uid;
            document.getElementById('editDisplayName').value = user.displayName || '';
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editRole').value = user.role || 'user';

            document.getElementById('editUserModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        // Save user edits
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const uid = document.getElementById('editUserId').value;
            const displayName = document.getElementById('editDisplayName').value;
            const role = document.getElementById('editRole').value;

            try {
                await database.ref(`users/${uid}`).update({
                    displayName: displayName,
                    role: role
                });
                alert('‚úÖ Utilisateur modifi√© avec succ√®s !');
                closeEditModal();
                refreshUsers();
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        });

        // Reset user progress
        async function confirmResetProgress(uid, displayName) {
            if (confirm(`‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\n√ätes-vous s√ªr de vouloir r√©initialiser la progression de "${displayName}" ?\n\nCela supprimera :\n- Tous les scores de quiz\n- Toute la progression des le√ßons\n- L'historique des diagnostics\n- Les favoris\n\nCette action est irr√©versible !`)) {
                try {
                    await database.ref(`users/${uid}`).update({
                        quizScores: {},
                        progress: {},
                        diagnosticHistory: [],
                        favorites: []
                    });
                    alert('‚úÖ Progression de "' + displayName + '" r√©initialis√©e !');
                    refreshUsers();
                } catch (error) {
                    alert('‚ùå Erreur: ' + error.message);
                }
            }
        }

        // Delete user
        async function confirmDeleteUser(uid, email, displayName) {
            const userName = displayName || email;
            if (confirm(`‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\n√ätes-vous s√ªr de vouloir supprimer l'utilisateur "${userName}" (${email}) ?\n\nCette action est irr√©versible et supprimera toutes ses donn√©es.`)) {
                const result = await deleteUser(uid);
                if (result.success) {
                    alert('‚úÖ Utilisateur "' + userName + '" supprim√© avec succ√®s !');
                    refreshUsers();
                } else {
                    alert('‚ùå Erreur: ' + result.error);
                }
            }
        }
    </script>
</body>

</html>